<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oral Exam Assistant</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
        }

        .container {
            width: 400px;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            text-align: center;
        }

        .play-button {
            background-color: #28a745;
            color: white;
            padding: 15px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            cursor: pointer;
            margin-bottom: 20px;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .play-button::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 15px solid white;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .countdown, .recording-icon, .transcription-result, .justification {
            font-size: 18px;
            margin-top: 10px;
        }

        .countdown {
            color: red;
            font-size: 24px;
            font-weight: bold;
        }

        .countdown-error {
            font-size: 12px;
        }

        .recording-icon {
            background: radial-gradient(circle at bottom, #ff0000 0%, #b20000 70%);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: background 0.3s ease;            
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }


        .recording-icon::before {
            content: '';
            background: radial-gradient(circle at bottom, #cc0000 0%, #ba0707 70%);
            border-radius: 50%;
            width: 75px;
            height: 75px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .recording-icon span {
            z-index: 1;
            color: white;
            font-size: 40px;
        }

        .play-indicator {
            font-size: 18px;
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .disabled-icon {
            background-color: grey;
            cursor: default;
        }

        .blue-bar {
            background-color: #4e8cff;
            height: 40px;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .blue-bar .buttons {
            display: flex;
            align-items: center;
            padding: 0 10px;
        }

        .blue-bar .buttons button {
            height: 40px;
            background-color: #4e8cff;
            color: white;
            border: none;
            margin-left: 10px;
            transition: background-color 0.3s;
            font-size: 16px;
            top: 0;
        }

        .blue-bar .buttons button:hover {
            background-color: #3666a3;
        }



    </style>
</head>
<body>

    <div class="container">
        <h2>Oral Exam Assistant</h2>
        <button id="playButton" class="play-button"></button>
        <div id="playIndicator" class="play-indicator hidden">Playing...</div>
        <div id="countdown" class="countdown hidden"></div>
        <div id="recordingIcon" class="recording-icon hidden"><span></span></div>
        <div id="transcriptionResult" class="transcription-result hidden"></div>
        <div id="justification" class="justification hidden"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;

        let media;

        const playButton = document.getElementById('playButton');
        const countdown = document.getElementById('countdown');
        const recordingIcon = document.getElementById('recordingIcon');
        const transcriptionResult = document.getElementById('transcriptionResult');
        const playIndicator = document.getElementById('playIndicator');
        const justification = document.getElementById('justification');

        playDisabled = true;
        media = navigator.mediaDevices.getUserMedia({ audio: true })
        media.then(() => {
            playDisabled = false;
        })
        .catch(error => console.error('Error accessing microphone:', error));


        const audio = new Audio('https://cdn.discordapp.com/attachments/1015856567830192168/1280598645988917258/question3.m4a?ex=66d9fb6d&is=66d8a9ed&hm=9732435845a91c4f944e8dd33d4b10dadc56849975c5ec113fb31ee43c98f33d&');

        countdown.addEventListener('click', () => {
            if (playDisabled) {
                media = navigator.mediaDevices.getUserMedia({ audio: true });
                media.then(() => {
                    playDisabled = false;
                    countdown.classList.add('hidden');
                    countdown.classList.remove('countdown-error');
                });
            }
        });

        playButton.addEventListener('click', () => {
            if (playDisabled) {
                countdown.classList.add('countdown-error');
                countdown.textContent = "Please allow microphone access to proceed. Click on this message to re-request access.";
                countdown.classList.remove('hidden');

                return;
            }
            audio.play();
            playIndicator.classList.remove('hidden');
            audio.addEventListener('ended', () => {
                playIndicator.classList.add('hidden');
                startCountdown(5);
            });
        });

        function startCountdown(seconds) {
            playButton.classList.add('hidden');
            let remainingTime = seconds;
            countdown.classList.remove('hidden');
            countdown.textContent = "Recording in: " + remainingTime;

            const countdownInterval = setInterval(() => {
                remainingTime--;
                countdown.textContent = "Recording in: " + remainingTime;

                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    startRecording();
                    countdown.textContent = "Recording...";
                }
            }, 1000);
        }

        function startRecording() {
            countdown.classList.add('hidden');
            media
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        handleRecordingStop();
                    };

                    mediaRecorder.start();
                    recordingIcon.classList.remove('hidden');
                })
                .catch(error => console.error('Error accessing microphone:', error));
        }

        recordingIcon.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordingIcon.classList.remove('recording-icon');
                recordingIcon.classList.add('disabled-icon');
            }
        });

        async function handleRecordingStop() {
            recordingIcon.classList.add('hidden');
            transcriptionResult.classList.remove('hidden');
            transcriptionResult.textContent = 'Processing...';
            await sendAudio();
            //await gradeAnswer(); // Proceed with transcription and grading
        }

        async function sendAudio() {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            const params = new URLSearchParams(window.location.search);

            const code = params.get('code');

            if (!code) {
                transcriptionResult.textContent = 'No room code provided. Please provide a code in the URL.';
                return;
            }

            const participant = params.get('participant');

            if (!participant) {
                transcriptionResult.textContent = 'No participant name provided. Please provide a participant name in the URL.';
                return;
            }

            const response = await fetch(`https://backend-8zsz.onrender.com/upload?code=${code}&participant=${participant}`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload audio');
            }

            const data = await response.json();

            console.log('Response:', data);

            if (data.error) {
                transcriptionResult.textContent = data.error;
                return;
            }

            transcriptionResult.textContent = 'Uploaded to server successfully. Tentative transcription: ' + data.transcription.text;

        }

        async function sendStatus() {
            const params = new URLSearchParams(window.location.search);

            const code = params.get('code');

            if (!code) {
                transcriptionResult.textContent = 'No room code provided. Please provide a code in the URL.';
                return;
            }

            const participant = params.get('participant');

            if (!participant) {
                transcriptionResult.textContent = 'No participant name provided. Please provide a participant name in the URL.';
                return;
            }

            const response = await fetch(`https://backend-8zsz.onrender.com/check_status?code=${code}&participant=${participant}`);

            if (!response.ok) {
                throw new Error('Failed to get status');
            }

            const data = await response.json();

            console.log('Response:', data);

            const responseCode = data.code;

            switch (responseCode) {
                case 1:
                    window.location.href = 'join-room';
                case 2:
                    window.location.href = 'join-room';
                    break;
                case 3:
                    break;
                case 4:
                    break;
                default:
                    window.location.href = 'join-room';
                    break;
            }

        }

        sendStatus();
        const statusInterval = setInterval(sendStatus, 1000);

        async function gradeAnswer() {  
            const base = 'c2stcHJvai13MXBJcU1iM1pZOU1HZC1hM3FUWl8yZXNibnFjdmlYMmFNMmVPLXFwT3lqWWU2LVRLNEpPdFpwemZ1VDNCbGJrRkpvRDR6RlRud3UwckhSLVMzUEduZTZPRFRLUnVPSDdMNFh1Q1pRTzZLN3RpMWFMRS1UcThDUWZ5WXdB';
            const apiKey = atob(base);
            const question = '¿Qué haces los fines de semana?';

            const newFormData = new FormData();
            newFormData.append('file', audioBlob, 'answer.wav');
            newFormData.append('model', 'whisper-1');
            newFormData.append('task', 'transcribe');
            

            try {
                const transcriptionResponse = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                    },
                    body: newFormData,
                });

                if (!transcriptionResponse.ok) {
                    throw new Error('Failed to transcribe audio');
                }

                const transcription = await transcriptionResponse.json();

                console.log(transcriptionResponse);

                const transcriptedAnswer = transcription.text || '[No answer provided]';




                console.log('Transcripted answer:', transcriptedAnswer);

                const language = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: 'You are an AI designed to classify the language of some text. You will be shown a text, and you will have to determine if it is in English or not. If it is in English, you will respond with "English". If it is not in English, you will respond with "Not English". You may only respond with English or Not English' },
                            { role: 'user', content: `The following is the student's response to the question: ${transcriptedAnswer}. Is this response in English?` },
                    ],
                    }),
                });

                if (!language.ok) {
                    throw new Error('Failed to classify the language');
                }

                const languageData = await language.json();

                const detectedLanguage = languageData.choices[0].message.content.trim();

                console.log('Language classification:', detectedLanguage);

                if (detectedLanguage === 'English') {
                    transcriptionResult.textContent = 'The student responded in English. No grading will be done.';
                    return;
                }
                

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: 'You are an AI designed to make Spanish teachers\' jobs easier, by grading oral exams. You will be shown the question, and then shown an AI transcript of the student\'s response. You will then grade the student in multiple categories. Max and min points of each category will be given.' },
                            { role: 'user', content: `Question: ${question}\n\nThe above is the question that the teacher asked. Do you understand the question and feel comfortable grading a student?`},
                            { role: 'assistant', content: 'Yes, I understand the question and feel comfortable grading a student.' },
                            { role: 'user', content: `In a moment, you will receive a transcript of the student's answer. Do you understand the implications of the fact that it is a transcript?` },
                            { role: 'assistant', content: 'Yes, I understand that I will not be grading at all based on punctuation, capitalization, or the like. I will only focus on the words themselves' },
                            { role: 'user', content: `Now, you will receive the transcript of the student's answer. Analyze quickly the answer before you will be asked to grade. Consider the fact that when grading, you may only present a number, without any text around it. That means no feedback or preface to your grade. The 3 categories are Vocabulary, Grammar, and Content. Make sure that the grades given are only for their categories, unless it is completely unrelated to the question or doesn't answer the question, in which case you can give them a one in all categories. Remember, if they meet the criteria for a category, they recieve a 5. These are still students, so be forgiving of small mistakes, since they're still learning. Now I will tell you if they gave their answer in English: ${detectedLanguage}. That was what they responded in.\n\nAnswer:${transcriptedAnswer}` },
                            { role: 'assistant', content: 'I have analyzed the answer and am ready to grade. I understand that the only output I must give from henceforth will be numerical. I also understand that if there is no cause to remove points, the student will receive full credit in a given category. I also understand that if their answer does not answer the question, they will not receive a good score. The same will be true if their answer is not conducive of an oral exam. If they were to give an answer such as "I like butterflies" to the question "What did you do yesterday?", for example, they would receieve 1s in all categories full credit in a given category. I remember that if their answer is unrelated, they will receive a low score. If their answer is in English, they will automatically recieve a 0 in every category. Their response is in the language you see it in. If their answer is in English, it\'s actually in English for real.' },
                            { role: 'user', content: 'Category 1 (1-5 pts): Vocabulary; Did the student use some vocabulary in their answer that demonstrates knowledge of the Spanish language? This basically means did they use words more complex than just \"bueno\" or \"malo\". If they did so, this category is a 5 automatically. As long as they used vocabulary well AND answered the question, it should always be a 5.' },
                            
                        ],
                    }),
                });

                if (!response.ok) {
                    throw new Error('Failed to grade the response');
                }

                const data = await response.json();

                console.log('Grading response:', data);

                transcriptionResult.textContent = "Vocabulary: " + data.choices[0].message.content.trim();

                // next category

                const response2 = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: 'You are an AI designed to make Spanish teachers\' jobs easier, by grading oral exams. You will be shown the question, and then shown an AI transcript of the student\'s response. You will then grade the student in multiple categories. Max and min points of each category will be given.' },
                            { role: 'user', content: `Question: ${question}\n\nThe above is the question that the teacher asked. Do you understand the question and feel comfortable grading a student?`},
                            { role: 'assistant', content: 'Yes, I understand the question and feel comfortable grading a student.' },
                            { role: 'user', content: `In a moment, you will receive a transcript of the student's answer. Do you understand the implications of the fact that it is a transcript?` },
                            { role: 'assistant', content: 'Yes, I understand that I will not be grading at all based on punctuation, capitalization, or the like. I will only focus on the words themselves' },
                            { role: 'user', content: `Now, you will receive the transcript of the student's answer. Analyze quickly the answer before you will be asked to grade. Consider the fact that when grading, you may only present a number, without any text around it. That means no feedback or preface to your grade. The 3 categories are Vocabulary, Grammar, and Content. Make sure that the grades given are only for their categories, unless it is completely unrelated to the question or doesn't answer the question, in which case you can give them a one in all categories. Remember, if they meet the criteria for a category, they recieve a 5. These are still students, so be forgiving of small mistakes, since they're still learning. Now I will tell you if they gave their answer in English: ${language}. That was what they responded in.\n\nAnswer:${transcriptedAnswer}` },
                            { role: 'assistant', content: 'I have analyzed the answer and am ready to grade. I understand that the only output I must give from henceforth will be numerical. I also understand that if there is no cause to remove points, the student will receive full credit in a given category. I also understand that if their answer does not answer the question, they will not receive a good score. The same will be true if their answer is not conducive of an oral exam. If they were to give an answer such as "I like butterflies" to the question "What did you do yesterday?", for example, they would receieve 1s in all categories full credit in a given category. I remember that if their answer is unrelated, they will receive a low score. If their answer is in English, they will automatically recieve a 0 in every category. Their response is in the language you see it in. If their answer is in English, it\'s actually in English for real.' },
                            { role: 'user', content: 'Category 1 (1-5 pts): Vocabulary; Did the student use some vocabulary in their answer that demonstrates knowledge of the Spanish language? This basically means did they use words more complex than just \"bueno\" or \"malo\". If they did so, this category is a 5 automatically. As long as they used vocabulary well AND answered the question, it should always be a 5.' },
                            { role: 'assistant', content:  data.choices[0].message.content.trim()},
                            { role: 'user', content: 'Category 2 (1-5 pts): Grammar; Did the student use correct grammar in their answer? This means did they use the correct verb conjugations, word order, subject-verb and gender agreement, etc. If there are no mistakes, this category is a 5 automatically. Be forgiving of tiny mistakes, since they are still learning. This should usually be a 5, unless they make a grammar mistake.' }
                        ],
                    }),
                });

                if (!response2.ok) {
                    throw new Error('Failed to grade the response');
                }

                const data2 = await response2.json();

                console.log('Grading response:', data2);

                transcriptionResult.textContent = "Vocabulary: " + data.choices[0].message.content.trim() + "\n" + "Grammar: " + data2.choices[0].message.content.trim();

                // next category

                const response3 = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: 'You are an AI designed to make Spanish teachers\' jobs easier, by grading oral exams. You will be shown the question, and then shown an AI transcript of the student\'s response. You will then grade the student in multiple categories. Max and min points of each category will be given.' },
                            { role: 'user', content: `Question: ${question}\n\nThe above is the question that the teacher asked. Do you understand the question and feel comfortable grading a student?`},
                            { role: 'assistant', content: 'Yes, I understand the question and feel comfortable grading a student.' },
                            { role: 'user', content: `In a moment, you will receive a transcript of the student's answer. Do you understand the implications of the fact that it is a transcript?` },
                            { role: 'assistant', content: 'Yes, I understand that I will not be grading at all based on punctuation, capitalization, or the like. I will only focus on the words themselves' },
                            { role: 'user', content: `Now, you will receive the transcript of the student's answer. Analyze quickly the answer before you will be asked to grade. Consider the fact that when grading, you may only present a number, without any text around it. That means no feedback or preface to your grade. The 3 categories are Vocabulary, Grammar, and Content. Make sure that the grades given are only for their categories, unless it is completely unrelated to the question or doesn't answer the question, in which case you can give them a one in all categories. Remember, if they meet the criteria for a category, they recieve a 5. These are still students, so be forgiving of small mistakes, since they're still learning. Now I will tell you if they gave their answer in English: ${language}. That was what they responded in.\n\nAnswer:${transcriptedAnswer}` },
                            { role: 'assistant', content: 'I have analyzed the answer and am ready to grade. I understand that the only output I must give from henceforth will be numerical. I also understand that if there is no cause to remove points, the student will receive full credit in a given category. I also understand that if their answer does not answer the question, they will not receive a good score. The same will be true if their answer is not conducive of an oral exam. If they were to give an answer such as "I like butterflies" to the question "What did you do yesterday?", for example, they would receieve 1s in all categories full credit in a given category. I remember that if their answer is unrelated, they will receive a low score. If their answer is in English, they will automatically recieve a 0 in every category. Their response is in the language you see it in. If their answer is in English, it\'s actually in English for real.' },
                            { role: 'user', content: 'Category 1 (1-5 pts): Vocabulary; Did the student use some vocabulary in their answer that demonstrates knowledge of the Spanish language? This basically means did they use words more complex than just \"bueno\" or \"malo\". If they did so, this category is a 5 automatically. If they did not use any vocabulary (nouns and adjectives), this category is a 1-3, depending on your judgement of their complexity.' },
                            { role: 'assistant', content:  data.choices[0].message.content.trim()},
                            { role: 'user', content: 'Category 2 (1-5 pts): Grammar; Did the student use correct grammar in their answer? This means did they use the correct verb conjugations, word order, subject-verb and gender agreement, etc. If there are no mistakes, this category is a 5 automatically.' },
                            { role: 'assistant', content:  data2.choices[0].message.content.trim()},
                            { role: 'user', content: 'Category 3 (1-5 pts): Content; Did the student answer the question in a way that makes sense? Did they provide enough information to answer the question? Did they use at least 2 conjugated verbs and at least 2 sentences? If they did so, this category is a 5 automatically. If their response was only a few words, this category is a 1. They must include a detailed' }
                        ],
                    }),
                });

                if (!response3.ok) {
                    throw new Error('Failed to grade the response');
                }

                const data3 = await response3.json();

                console.log('Grading response:', data3);

                transcriptionResult.textContent = "Vocabulary: " + data.choices[0].message.content.trim() + "\n" + "Grammar: " + data2.choices[0].message.content.trim() + "\n" + "Content: " + data3.choices[0].message.content.trim();



            } catch (error) {
                console.error('Error:', error);
                justification.textContent = 'Failed to grade the response.';
                justification.textContent = 'No justification available.';
            }
        }
    </script>
</body>
</html>
